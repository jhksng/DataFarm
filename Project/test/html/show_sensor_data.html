<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>센서 데이터 현황 - 스마트팜 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-slate-100">

<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebarFragment(active='sensor-data')}"></div>

    <main class="flex-1 p-8 overflow-y-auto">
        <h2 class="text-3xl font-bold text-slate-800 mb-6">센서 데이터 현황</h2>

        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 mb-8">
            <h3 class="text-xl font-semibold text-slate-700 mb-1">가장 최근 측정값</h3>
            <div th:if="${latestSensorData}">
                <p class="text-sm text-slate-500 mb-4">
                    <strong>측정 시간:</strong> <span th:text="${#temporals.format(latestSensorData.timestamp, 'yyyy-MM-dd HH:mm:ss')}"></span>
                </p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-red-50 p-4 rounded-lg"><p class="text-sm text-slate-500">온도</p><p class="text-2xl font-bold" th:text="${latestSensorData.temperature} + '°C'"></p></div>
                    <div class="bg-sky-50 p-4 rounded-lg"><p class="text-sm text-slate-500">습도</p><p class="text-2xl font-bold" th:text="${latestSensorData.humidity} + '%'"></p></div>
                    <div class="bg-amber-50 p-4 rounded-lg"><p class="text-sm text-slate-500">토양습도</p><p class="text-2xl font-bold" th:text="${latestSensorData.soilMoisture} + '%'"></p></div>
                    <div class="bg-indigo-50 p-4 rounded-lg"><p class="text-sm text-slate-500">물 수위</p><p class="text-2xl font-bold" th:text="${latestSensorData.waterLevel}"></p></div>
                </div>
            </div>
            <div th:unless="${latestSensorData}" class="text-center text-gray-500 py-10">
                <p>최근 측정된 데이터가 없습니다.</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-slate-200">
            <div class="p-6 border-b border-slate-200">
                <h3 class="text-xl font-semibold text-slate-700">실시간 모니터링 그래프</h3>
            </div>
            <div class="p-6">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/sidebar :: sidebarScript}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 페이지가 로드되면 '/api/sensor-data/recent' API를 호출합니다.
        fetch('/api/sensor-data/recent')
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버에서 데이터를 가져오지 못했습니다.');
                }
                return response.json();
            })
            .then(data => {
                if (!data || data.length === 0) {
                    console.log("그래프를 그릴 데이터가 없습니다.");
                    return;
                }

                // API는 최신순(내림차순)으로 데이터를 보내주므로, 그래프에 시간순(오름차순)으로 그리려면 배열을 뒤집어야 합니다.
                data.reverse();

                const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }));
                const temperatures = data.map(d => d.temperature);
                const humidities = data.map(d => d.humidity);
                const soilMoistures = data.map(d => d.soilMoisture);
                const waterLevels = data.map(d => d.waterLevel);

                const ctx = document.getElementById('sensorChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: '온도 (°C)', data: temperatures, borderColor: 'rgba(239, 68, 68, 1)', tension: 0.1, pointRadius: 2, pointHoverRadius: 5, pointHitRadius: 10 },
                            { label: '습도 (%)', data: humidities, borderColor: 'rgba(14, 165, 233, 1)', tension: 0.1, pointRadius: 2, pointHoverRadius: 5, pointHitRadius: 10 },
                            { label: '토양습도 (%)', data: soilMoistures, borderColor: 'rgba(245, 158, 11, 1)', tension: 0.1, pointRadius: 2, pointHoverRadius: 5, pointHitRadius: 10 },
                            { label: '물 수위', data: waterLevels, borderColor: 'rgba(99, 102, 241, 1)', tension: 0.1, pointRadius: 2, pointHoverRadius: 5, pointHitRadius: 10 }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { title: { display: true, text: '시간' } },
                            y: { title: { display: true, text: '값' } }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching chart data:', error));
    });
</script>
</body>
</html>