<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>전체 센서 기록 - 스마트팜 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .filter-group label { display: flex; align-items: center; gap: 0.5rem; }
        .filter-group input[type=checkbox] { width: 1rem; height: 1rem; cursor: pointer;}
        .filter-group > div > label { margin-bottom: 0.25rem; }
    </style>
</head>
<body class="bg-slate-100">

<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebarFragment(active='sensor-history')}"></div>

    <main class="flex-1 p-8 overflow-y-auto">
        <h2 class="text-3xl font-bold text-slate-800 mb-6">전체 센서 기록</h2>

        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 mb-8">
            <form th:action="@{/sensor_history}" method="get">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-8 items-start">

                    <div class="space-y-3 filter-group">
                        <label for="filterDateEnabled">
                            <input type="checkbox" id="filterDateEnabled" name="filterDateEnabled" value="true" th:checked="${filterDateEnabled}">
                            <span class="font-medium text-gray-700">기간 검색</span>
                        </label>
                        <div>
                            <label for="startDate" class="block text-sm text-gray-600">시작일</label>
                            <input type="datetime-local" id="startDate" name="startDate" th:value="${startDate}"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm text-gray-600">종료일</label>
                            <input type="datetime-local" id="endDate" name="endDate" th:value="${endDate}"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <p th:if="${parsingError}" class="text-red-500 text-sm" th:text="${parsingError}"></p>
                    </div>

                    <div class="space-y-3 filter-group">
                        <label for="filterTempEnabled">
                            <input type="checkbox" id="filterTempEnabled" name="filterTempEnabled" value="true" th:checked="${filterTempEnabled}">
                            <span class="font-medium text-gray-700">온도 (°C)</span>
                        </label>
                        <div>
                            <label for="minTemp" class="block text-sm text-gray-600">최소</label>
                            <input type="number" step="0.1" id="minTemp" name="minTemp" th:value="${minTemp}" placeholder="예: 10.0"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="maxTemp" class="block text-sm text-gray-600">최대</label>
                            <input type="number" step="0.1" id="maxTemp" name="maxTemp" th:value="${maxTemp}" placeholder="예: 30.0"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="space-y-3 filter-group">
                        <label for="filterHumiEnabled">
                            <input type="checkbox" id="filterHumiEnabled" name="filterHumiEnabled" value="true" th:checked="${filterHumiEnabled}">
                            <span class="font-medium text-gray-700">습도 (%)</span>
                        </label>
                        <div>
                            <label for="minHumi" class="block text-sm text-gray-600">최소</label>
                            <input type="number" step="0.1" id="minHumi" name="minHumi" th:value="${minHumi}" placeholder="예: 40.0"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="maxHumi" class="block text-sm text-gray-600">최대</label>
                            <input type="number" step="0.1" id="maxHumi" name="maxHumi" th:value="${maxHumi}" placeholder="예: 80.0"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="space-y-3 filter-group">
                        <label for="filterSoilEnabled">
                            <input type="checkbox" id="filterSoilEnabled" name="filterSoilEnabled" value="true" th:checked="${filterSoilEnabled}">
                            <span class="font-medium text-gray-700">토양습도 (%)</span>
                        </label>
                        <div>
                            <label for="minSoil" class="block text-sm text-gray-600">최소</label>
                            <input type="number" step="0.1" id="minSoil" name="minSoil" th:value="${minSoil}" placeholder="예: 30.0"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="maxSoil" class="block text-sm text-gray-600">최대</label>
                            <input type="number" step="0.1" id="maxSoil" name="maxSoil" th:value="${maxSoil}" placeholder="예: 70.0"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="space-y-3 filter-group">
                        <label for="filterWaterEnabled">
                            <input type="checkbox" id="filterWaterEnabled" name="filterWaterEnabled" value="true" th:checked="${filterWaterEnabled}">
                            <span class="font-medium text-gray-700">물 수위</span>
                        </label>
                        <div>
                            <label for="minWater" class="block text-sm text-gray-600">최소</label>
                            <input type="number" id="minWater" name="minWater" th:value="${minWater}" placeholder="예: 10"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="maxWater" class="block text-sm text-gray-600">최대</label>
                            <input type="number" id="maxWater" name="maxWater" th:value="${maxWater}" placeholder="예: 90"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="space-y-3 filter-group">
                        <label for="filterDeviceEnabled">
                            <input type="checkbox" id="filterDeviceEnabled" name="filterDeviceEnabled" value="true" th:checked="${filterDeviceEnabled}">
                            <span class="font-medium text-gray-700">장치 ID</span>
                        </label>
                        <div>
                            <input type="text" id="deviceId" name="deviceId" placeholder="raspi-01" th:value="${deviceId}"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="hidden lg:block"></div>
                    <div class="hidden lg:block"></div>

                </div>

                <div class="flex justify-end gap-4 mt-8 pt-6 border-t">
                    <a th:href="@{/sensor_history}" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 transition-colors">초기화</a>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">검색</button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-x-auto">
            <table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                <tr>
                    <th scope="col" class="px-6 py-3">ID</th>
                    <th scope="col" class="px-6 py-3">장치 ID</th>
                    <th scope="col" class="px-6 py-3">온도 (°C)</th>
                    <th scope="col" class="px-6 py-3">습도 (%)</th>
                    <th scope="col" class="px-6 py-3">토양습도 (%)</th>
                    <th scope="col" class="px-6 py-3">물 수위</th>
                    <th scope="col" class="px-6 py-3">시간</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="data : ${sensorDataList}" class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4" th:text="${data.id}"></td>
                    <td class="px-6 py-4 font-medium text-slate-900" th:text="${data.raspberryId}"></td>
                    <td class="px-6 py-4" th:text="${#numbers.formatDecimal(data.temperature, 1, 2)}"></td>
                    <td class="px-6 py-4" th:text="${#numbers.formatDecimal(data.humidity, 1, 2)}"></td>
                    <td class="px-6 py-4" th:text="${#numbers.formatDecimal(data.soilMoisture, 1, 2)}"></td>
                    <td class="px-6 py-4" th:text="${data.waterLevel}"></td>
                    <td class="px-6 py-4 sensor-time"
                        th:attr="data-time=${#temporals.format(data.timestamp, 'yyyy-MM-dd''T''HH:mm:ss')}">
                        <!-- JS에서 +9시간 보정해서 표시 -->
                    </td>

                </tr>
                <tr th:if="${#lists.isEmpty(sensorDataList)}">
                    <td colspan="7" class="text-center py-8 text-slate-500">기록된 데이터가 없거나, 검색 조건에 맞는 결과가 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-center items-center" th:if="${totalPages > 0}">
            <nav class="flex items-center gap-2">
                <a th:if="${currentPage > 0}"
                   th:href="@{/sensor_history(page=${currentPage - 1}, size=${size},
                       filterDateEnabled=${filterDateEnabled}, startDate=${startDate}, endDate=${endDate},
                       filterTempEnabled=${filterTempEnabled}, minTemp=${minTemp}, maxTemp=${maxTemp},
                       filterHumiEnabled=${filterHumiEnabled}, minHumi=${minHumi}, maxHumi=${maxHumi},
                       filterSoilEnabled=${filterSoilEnabled}, minSoil=${minSoil}, maxSoil=${maxSoil},
                       filterWaterEnabled=${filterWaterEnabled}, minWater=${minWater}, maxWater=${maxWater},
                       filterDeviceEnabled=${filterDeviceEnabled}, deviceId=${deviceId})}"
                   class="px-3 py-2 text-slate-600 bg-white rounded-md hover:bg-blue-500 hover:text-white border border-slate-200 transition-colors">
                    &laquo; 이전
                </a>

                <th:block th:with="startPage=${T(java.lang.Math).max(0, currentPage - 2)}, endPage=${T(java.lang.Math).min(totalPages - 1, currentPage + 2)}">
                    <th:block th:each="i : ${#numbers.sequence(startPage, endPage)}">
                        <a th:href="@{/sensor_history(page=${i}, size=${size},
                               filterDateEnabled=${filterDateEnabled}, startDate=${startDate}, endDate=${endDate},
                               filterTempEnabled=${filterTempEnabled}, minTemp=${minTemp}, maxTemp=${maxTemp},
                               filterHumiEnabled=${filterHumiEnabled}, minHumi=${minHumi}, maxHumi=${maxHumi},
                               filterSoilEnabled=${filterSoilEnabled}, minSoil=${minSoil}, maxSoil=${maxSoil},
                               filterWaterEnabled=${filterWaterEnabled}, minWater=${minWater}, maxWater=${maxWater},
                               filterDeviceEnabled=${filterDeviceEnabled}, deviceId=${deviceId})}"
                           th:text="${i + 1}"
                           th:classappend="${i == currentPage} ? 'bg-blue-600 text-white font-bold' : 'bg-white text-slate-600'"
                           class="px-4 py-2 rounded-md hover:bg-blue-500 hover:text-white border border-slate-200 transition-colors">
                        </a>
                    </th:block>
                </th:block>

                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/sensor_history(page=${currentPage + 1}, size=${size},
                       filterDateEnabled=${filterDateEnabled}, startDate=${startDate}, endDate=${endDate},
                       filterTempEnabled=${filterTempEnabled}, minTemp=${minTemp}, maxTemp=${maxTemp},
                       filterHumiEnabled=${filterHumiEnabled}, minHumi=${minHumi}, maxHumi=${maxHumi},
                       filterSoilEnabled=${filterSoilEnabled}, minSoil=${minSoil}, maxSoil=${maxSoil},
                       filterWaterEnabled=${filterWaterEnabled}, minWater=${minWater}, maxWater=${maxWater},
                       filterDeviceEnabled=${filterDeviceEnabled}, deviceId=${deviceId})}"
                   class="px-3 py-2 text-slate-600 bg-white rounded-md hover:bg-blue-500 hover:text-white border border-slate-200 transition-colors">
                    다음 &raquo;
                </a>
            </nav>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const timeCells = document.querySelectorAll('.sensor-time');
        timeCells.forEach(cell => {
            const utcTime = cell.getAttribute('data-time');
            if (!utcTime) return;

            // UTC → KST (+9시간)
            const date = new Date(utcTime);
            const kstDate = new Date(date.getTime() + 9 * 60 * 60 * 1000);

            // YYYY-MM-DD HH:mm:ss 포맷
            const formatted = `${kstDate.getFullYear()}-${String(kstDate.getMonth() + 1).padStart(2, '0')}-${String(kstDate.getDate()).padStart(2, '0')} ` +
                              `${String(kstDate.getHours()).padStart(2, '0')}:${String(kstDate.getMinutes()).padStart(2, '0')}:${String(kstDate.getSeconds()).padStart(2, '0')}`;
            cell.textContent = formatted;
        });
    });
</script>

<div th:replace="~{fragments/sidebar :: sidebarScript}"></div>
</body>
</html>