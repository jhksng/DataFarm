<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>센서 데이터 현황 - 스마트팜 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .active-btn { background-color: #2563eb; color: white; font-weight: 600; }
        .inactive-btn { background-color: #e5e7eb; color: #374151; }
    </style>
</head>

<body class="bg-slate-100">

<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebarFragment(active='show-sensor-data')}"></div>

    <main class="flex-1 p-8 overflow-y-auto">
        <h2 class="text-3xl font-bold text-slate-800 mb-6">센서 데이터 현황</h2>

        <!-- ✅ 간격 전환 버튼 -->
        <div class="flex gap-3 mb-6">
            <button id="btn-minute" class="px-4 py-2 rounded-md inactive-btn" onclick="setViewMode('minute')">1분 간격</button>
            <button id="btn-hour" class="px-4 py-2 rounded-md inactive-btn" onclick="setViewMode('hour')">1시간 간격</button>
            <button id="btn-day" class="px-4 py-2 rounded-md inactive-btn" onclick="setViewMode('day')">1일 간격</button>
            <button id="btn-week" class="px-4 py-2 rounded-md inactive-btn" onclick="setViewMode('week')">1주 간격</button>
            <button id="btn-month" class="px-4 py-2 rounded-md inactive-btn" onclick="setViewMode('month')">1달 간격</button>
        </div>

        <!-- ✅ 가장 최근 데이터 카드 -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 mb-8">
            <h3 class="text-xl font-semibold text-slate-700 mb-2">가장 최근 측정값</h3>

            <p id="latestTimeText" class="text-sm text-slate-500 mb-4"
               th:if="${latestSensorData != null}"
               th:attr="data-time=${#temporals.format(latestSensorData.timestamp, 'yyyy-MM-dd''T''HH:mm:ss')}">
            </p>
            <p class="text-sm text-slate-500 mb-4" th:unless="${latestSensorData != null}">측정된 데이터가 없습니다.</p>

            <div th:if="${latestSensorData != null}" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 rounded-lg bg-red-50 border border-red-100 text-center">
                    <p class="text-sm text-red-700">온도</p>
                    <p class="text-2xl font-bold text-red-900"
                       th:text="${#numbers.formatDecimal(latestSensorData.temperature, 1, 1)} + '°C'"></p>
                </div>
                <div class="p-4 rounded-lg bg-sky-50 border border-sky-100 text-center">
                    <p class="text-sm text-sky-700">습도</p>
                    <p class="text-2xl font-bold text-sky-900"
                       th:text="${#numbers.formatDecimal(latestSensorData.humidity, 1, 1)} + '%'"></p>
                </div>
                <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-100 text-center">
                    <p class="text-sm text-yellow-700">토양습도</p>
                    <p class="text-2xl font-bold text-yellow-900"
                       th:text="${#numbers.formatDecimal(latestSensorData.soilMoisture, 1, 1)} + '%'"></p>
                </div>
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-100 text-center">
                    <p class="text-sm text-blue-700">물 수위</p>
                    <p class="text-2xl font-bold text-blue-900"
                       th:text="${latestSensorData.waterLevel} + '%'"></p>
                </div>
            </div>
        </div>

        <!-- ✅ 그래프 영역 -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
            <h3 class="text-xl font-semibold text-slate-700 mb-4">실시간 모니터링 그래프</h3>
            <div class="relative h-80">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/sidebar :: sidebarScript}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let chartInstance = null;
    let currentMode = 'minute';
    let refreshInterval = null;

    document.addEventListener('DOMContentLoaded', () => {
        updateActiveButton();
        loadSensorData();
        resetAutoRefresh();
    });

    // ✅ 버튼 상태 갱신
    function updateActiveButton() {
        const buttons = {
            minute: document.getElementById('btn-minute'),
            hour: document.getElementById('btn-hour'),
            day: document.getElementById('btn-day'),
            week: document.getElementById('btn-week'),
            month: document.getElementById('btn-month')
        };
        Object.keys(buttons).forEach(mode => {
            buttons[mode].classList.remove('active-btn', 'inactive-btn');
            buttons[mode].classList.add(mode === currentMode ? 'active-btn' : 'inactive-btn');
        });
    }

    // ✅ 모드 전환
    function setViewMode(mode) {
        currentMode = mode;
        updateActiveButton();
        loadSensorData();
        resetAutoRefresh();
    }

    // ✅ 데이터 불러오기
    async function loadSensorData() {
        const endpointMap = {
            minute: '/api/sensor-data/minute',
            hour: '/api/sensor-data/hourly',
            day: '/api/sensor-data/daily',
            week: '/api/sensor-data/weekly',
            month: '/api/sensor-data/monthly'
        };
        const endpoint = endpointMap[currentMode];

        try {
            const res = await fetch(endpoint);
            const data = await res.json();

            if (!data || data.length === 0) {
                drawEmptyChart("데이터가 없습니다.");
                return;
            }

            const labels = data.map(item => {
                const ts = item.timestamp;

                // ✅ ① 주차 데이터 처리 (예: 2025-10-w3 → 10월 3주차)
                if (typeof ts === 'string' && ts.includes('-w')) {
                    const [year, month, week] = ts.split('-');
                    return `${parseInt(month)}월 ${week.replace('w', '')}주차`;
                }

                // date
                if (typeof ts === 'string') {
                    const date = new Date(ts); // 'Z' 제거
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const hour = date.getHours().toString().padStart(2, '0');
                    const minute = date.getMinutes().toString().padStart(2, '0');

                    if (currentMode === 'minute') return `${month}/${day} ${hour}:${minute}`;
                    if (currentMode === 'hour') return `${month}/${day} ${hour}시`;
                    if (currentMode === 'day') return `${month}/${day}`;
                    if (currentMode === 'month') return `${month}월`;
                    return `${month}/${day} ${hour}:${minute}`;
                }

                return ts;
            });

            const temperatureData = data.map(item => item.temperature);
            const humidityData = data.map(item => item.humidity);
            const soilMoistureData = data.map(item => item.soilMoisture);
            const waterLevelData = data.map(item => item.waterLevel);

            drawChart(labels, temperatureData, humidityData, soilMoistureData, waterLevelData);

        } catch (e) {
            console.error('데이터 로딩 실패:', e);
            drawEmptyChart("그래프 데이터 로딩 오류");
        }
    }

    // ✅ 차트 그리기
    function drawChart(labels, temperatureData, humidityData, soilMoistureData, waterLevelData) {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '온도 (°C)',
                        data: temperatureData,
                        borderColor: 'rgb(255,99,132)',
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'yTemperature'
                    },
                    {
                        label: '습도 (%)',
                        data: humidityData,
                        borderColor: 'rgb(54,162,235)',
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'yHumidity'
                    },
                    {
                        label: '토양습도 (%)',
                        data: soilMoistureData,
                        borderColor: 'rgb(255,205,86)',
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'yHumidity'
                    },
                    {
                        label: '물 수위 (%)',
                        data: waterLevelData,
                        borderColor: 'rgb(153,102,255)',
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'yHumidity'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(ctx) {
                                let label = ctx.dataset.label || '';
                                if (label) label += ': ';
                                if (ctx.parsed.y != null) {
                                    label += ctx.parsed.y.toFixed(1);
                                    if (label.includes('온도')) label += ' °C';
                                    else label += ' %';
                                }
                                return label;
                            }
                        }
                    },
                    legend: { display: true }
                },
                scales: {
                    x: { title: { display: true, text: '시간' } },
                    yTemperature: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: '온도 (°C)' }
                    },
                    yHumidity: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '습도 / 토양 / 수위 (%)' },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    // ✅ 에러/빈 데이터 차트 표시
    function drawEmptyChart(message) {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = "16px Noto Sans KR";
        ctx.textAlign = "center";
        ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
    }

    // ✅ 1분마다 자동 갱신
    function resetAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(loadSensorData, 60000);
    }
    /*]]>*/
</script>

</body>
</html>
