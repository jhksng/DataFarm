<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>센서 데이터 현황 - 스마트팜 대시보드</title> <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
</style>
</head>
<body class="bg-slate-100">

<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebarFragment(active='sensor-status')}"></div> <main class="flex-1 p-8 overflow-y-auto">
    <h2 class="text-3xl font-bold text-slate-800 mb-6">센서 데이터 현황</h2>

    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 mb-8">
        <h3 class="text-xl font-semibold text-slate-700 mb-2">가장 최근 측정값</h3>

        <p id="latestTimeText" class="text-sm text-slate-500 mb-4"
           th:if="${latestSensorData != null}"
           th:attr="data-time=${#temporals.format(latestSensorData.timestamp, 'yyyy-MM-dd''T''HH:mm:ss')}">
        </p>

        <p class="text-sm text-slate-500 mb-4" th:unless="${latestSensorData != null}">측정된 데이터가 없습니다.</p>

        <div th:if="${latestSensorData != null}" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="p-4 rounded-lg bg-red-50 border border-red-100 text-center">
                <p class="text-sm text-red-700">온도</p>
                <p class="text-2xl font-bold text-red-900" th:text="${#numbers.formatDecimal(latestSensorData.temperature, 1, 1)} + '°C'"></p>
            </div>
            <div class="p-4 rounded-lg bg-sky-50 border border-sky-100 text-center">
                <p class="text-sm text-sky-700">습도</p>
                <p class="text-2xl font-bold text-sky-900" th:text="${#numbers.formatDecimal(latestSensorData.humidity, 1, 1)} + '%'"></p>
            </div>
            <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-100 text-center">
                <p class="text-sm text-yellow-700">토양습도</p>
                <p class="text-2xl font-bold text-yellow-900" th:text="${#numbers.formatDecimal(latestSensorData.soilMoisture, 1, 1)} + '%'"></p>
            </div>
            <div class="p-4 rounded-lg bg-blue-50 border border-blue-100 text-center">
                <p class="text-sm text-blue-700">물 수위</p>
                <p class="text-2xl font-bold text-blue-900" th:text="${latestSensorData.waterLevel} + '%'"></p>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
        <h3 class="text-xl font-semibold text-slate-700 mb-4">실시간 모니터링 그래프</h3>

        <div class="relative h-72">
            <canvas id="sensorChart"></canvas>
        </div>
    </div>
</main>
</div>

<div th:replace="~{fragments/sidebar :: sidebarScript}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', async function() { // async 추가
    // ✅ 상단 측정 시간 표시를 KST(+9h)로 보정
const latestTimeEl = document.getElementById('latestTimeText');
if (latestTimeEl && latestTimeEl.getAttribute('data-time')) {
    const utcDate = new Date(latestTimeEl.getAttribute('data-time'));
    const kstDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);
    const formatted = `${kstDate.getFullYear()}-${String(kstDate.getMonth() + 1).padStart(2, '0')}-${String(kstDate.getDate()).padStart(2, '0')} ` +
                      `${String(kstDate.getHours()).padStart(2, '0')}:${String(kstDate.getMinutes()).padStart(2, '0')}:${String(kstDate.getSeconds()).padStart(2, '0')}`;
    latestTimeEl.textContent = `측정 시간: ${formatted}`;
}



        try {
            // API에서 최신 데이터 가져오기
            const response = await fetch('/api/sensor-data/recent'); // /recent 엔드포인트만 호출
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data && data.length > 0) {
                // 데이터 포맷팅
                const labels = data.map(item => {
    const utcDate = new Date(item.timestamp);
    const kstDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);
    return `${kstDate.getHours().toString().padStart(2, '0')}:${kstDate.getMinutes().toString().padStart(2, '0')}`;
});
                const temperatureData = data.map(item => item.temperature);
                const humidityData = data.map(item => item.humidity);
                const soilMoistureData = data.map(item => item.soilMoisture);
                const waterLevelData = data.map(item => item.waterLevel);

                // 차트 생성
                const ctx = document.getElementById('sensorChart').getContext('2d');
                new Chart(ctx, { // 차트 객체를 전역 변수에 저장할 필요 없음
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '온도 (°C)',
                                data: temperatureData,
                                borderColor: 'rgb(255, 99, 132)',
                                tension: 0.1,
                                yAxisID: 'yTemperature'
                            },
                            {
                                label: '습도 (%)',
                                data: humidityData,
                                borderColor: 'rgb(54, 162, 235)',
                                tension: 0.1,
                                yAxisID: 'yHumidity'
                            },
                            {
                                label: '토양습도 (%)',
                                data: soilMoistureData,
                                borderColor: 'rgb(255, 205, 86)',
                                tension: 0.1,
                                yAxisID: 'yHumidity'
                            },
                            {
                                label: '물 수위',
                                data: waterLevelData,
                                borderColor: 'rgb(153, 102, 255)',
                                tension: 0.1,
                                yAxisID: 'yHumidity'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                display: true,
                                title: { display: true, text: '시간' }
                            },
                            yTemperature: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: '온도 (°C)' },
                            },
                            yHumidity: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: '습도/토양/수위 (%)' },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                grid: { drawOnChartArea: false }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                            // 범례는 기본적으로 표시됨
                        }
                    }
                });
            } else {
                console.log("No recent sensor data found.");
                // 데이터 없을 때 메시지 표시
                const ctx = document.getElementById('sensorChart').getContext('2d');
                ctx.textAlign = 'center';
                ctx.fillText('최근 센서 데이터가 없습니다.', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        } catch (error) {
            console.error('Error loading initial chart data:', error);
            // 에러 시 메시지 표시
            const ctx = document.getElementById('sensorChart').getContext('2d');
            ctx.textAlign = 'center';
            ctx.fillText('그래프 데이터 로딩 중 오류 발생.', ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    });
    /*]]>*/
</script>

</body>
</html>